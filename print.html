<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Khue&#x27;s Homelab</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="SUMMARY.html">Table of contents</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="deployment/index.html"><strong aria-hidden="true">1.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="deployment/provisioning_flow.html"><strong aria-hidden="true">1.1.</strong> Provisioning flow</a></li><li class="chapter-item expanded "><a href="deployment/hardware_requirements.html"><strong aria-hidden="true">1.2.</strong> Harware requirements</a></li><li class="chapter-item expanded "><a href="deployment/prerequisites.html"><strong aria-hidden="true">1.3.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="deployment/configuration.html"><strong aria-hidden="true">1.4.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="deployment/deployment.html"><strong aria-hidden="true">1.5.</strong> Deploy the homelab</a></li></ol></li><li class="chapter-item expanded "><a href="troubleshooting/index.html"><strong aria-hidden="true">2.</strong> Troubleshooting</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="troubleshooting/pxe_boot.html"><strong aria-hidden="true">2.1.</strong> PXE boot</a></li></ol></li><li class="chapter-item expanded "><a href="reference/index.html"><strong aria-hidden="true">3.</strong> Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/architecture.html"><strong aria-hidden="true">3.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="reference/faq.html"><strong aria-hidden="true">3.2.</strong> FAQ</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="changelog.html"><strong aria-hidden="true">4.</strong> Changelog</a></li><li class="chapter-item expanded "><a href="roadmap.html"><strong aria-hidden="true">5.</strong> Roadmap</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Khue&#x27;s Homelab</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/khuedoan/homelab" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="summary"><a class="header" href="#summary">Summary</a></h1>
<p><a href="./SUMMARY.html">Table of contents</a></p>
<hr />
<ul>
<li><a href="./deployment/README.html">Deployment</a>
<ul>
<li><a href="./deployment/provisioning_flow.html">Provisioning flow</a></li>
<li><a href="./deployment/hardware_requirements.html">Harware requirements</a></li>
<li><a href="./deployment/prerequisites.html">Prerequisites</a></li>
<li><a href="./deployment/configuration.html">Configuration</a></li>
<li><a href="./deployment/deployment.html">Deploy the homelab</a></li>
</ul>
</li>
<li><a href="./troubleshooting/README.html">Troubleshooting</a>
<ul>
<li><a href="./troubleshooting/pxe_boot.html">PXE boot</a></li>
</ul>
</li>
<li><a href="./reference/README.html">Reference</a>
<ul>
<li><a href="./reference/architecture.html">Architecture</a></li>
<li><a href="./reference/faq.html">FAQ</a></li>
</ul>
</li>
</ul>
<hr />
<ul>
<li><a href="./changelog.html">Changelog</a></li>
<li><a href="./roadmap.html">Roadmap</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deployment"><a class="header" href="#deployment">Deployment</a></h1>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="provisioning-flow"><a class="header" href="#provisioning-flow">Provisioning flow</a></h1>
<p><img src="deployment/../diagrams/provisioning_flow.jpg" alt="Provisioning flow" /></p>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hardware-requirements"><a class="header" href="#hardware-requirements">Hardware requirements</a></h1>
<h2 id="initial-controller"><a class="header" href="#initial-controller">Initial controller</a></h2>
<blockquote>
<p>The initial controller is the machine used to bootstrap the cluster.</p>
</blockquote>
<ul>
<li>Any machine that can run Linux and Docker should work (I'm using my laptop).</li>
<li>Wired Ethernet connection is prefered (Wifi is untested, please let me know if it works)</li>
</ul>
<h2 id="server-hardware"><a class="header" href="#server-hardware">Server hardware</a></h2>
<blockquote>
<p>This is the requirements for <em>each</em> node</p>
</blockquote>
<ul>
<li>
<p>Minimum:</p>
<ul>
<li>1 node</li>
<li>At least 2 cores</li>
<li>At least 8GB of RAM</li>
<li>At least 128GB of hard drive</li>
</ul>
</li>
<li>
<p>Recommended:</p>
<ul>
<li>3 nodes or more for high availability</li>
<li>4 cores</li>
<li>16GB of RAM</li>
<li>512GB of hard drive (depending on your storage usage, the base installation will not use more than 128GB)</li>
</ul>
</li>
<li>
<p>Ability to boot from the network (PXE boot)</p>
</li>
<li>
<p>Wake-on-LAN capability, used to wake the machines up automatically without physically touching the power button</p>
</li>
<li>
<p>Connected to the same <strong>wired</strong> network with the initial controller (for DHCP broadcast)</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h1>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deploy-the-homelab"><a class="header" href="#deploy-the-homelab">Deploy the homelab</a></h1>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h1>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pxe-boot"><a class="header" href="#pxe-boot">PXE boot</a></h1>
<h2 id="pxe-server-logs"><a class="header" href="#pxe-server-logs">PXE server logs</a></h2>
<p>To view PXE server (includes DHCP, TFTP and HTTP server) logs:</p>
<pre><code class="language-sh">docker-compose --project-directory ./metal/roles/pxe-server/build/ logs --follow
</code></pre>
<h2 id="nodes-not-booting-from-the-network"><a class="header" href="#nodes-not-booting-from-the-network">Nodes not booting from the network</a></h2>
<ul>
<li>Plug a monitor and a keyboard to one of the bare metal node if possible to make the debugging process easier</li>
<li>Check if the controller (PXE server) is on the same subnet with bare metal nodes (sometimes Wifi will not work or conflict with wired Ethernet, try to turn it off)</li>
<li>Check if bare metal nodes are configured to boot from the network</li>
<li>Check if Wake-on-LAN is enabled</li>
<li>Check if the operating system ISO file is mounted</li>
<li>Check the controller firewall config</li>
<li>Check PXE server Docker logs</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="reference"><a class="header" href="#reference">Reference</a></h1>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="faq"><a class="header" href="#faq">FAQ</a></h1>
<h2 id="do-i-need-to-install-linux-on-my-servers-before-provisioning-the-homelab"><a class="header" href="#do-i-need-to-install-linux-on-my-servers-before-provisioning-the-homelab">Do I need to install Linux on my servers before provisioning the homelab?</a></h2>
<p>No, and it's the beauty of this set up. You start from scratch (empty hard drive), type a single command on your laptop/PC and it will install the OS for you automatically, in parallel via the network.</p>
<h2 id="do-i-need-to-keep-the-pxe-server-running"><a class="header" href="#do-i-need-to-keep-the-pxe-server-running">Do I need to keep the PXE server running?</a></h2>
<p>No, the ephemeral PXE server is stateless, after Linux is installed on your servers you can shut it down (or not, ideally you don't even need to care about its existence).
The Ansible set up in <code>./metal</code> is idempotent and will start the PXE server if needed.</p>
<h2 id="why-use-fedora-coreos-instead-of-a-traditional-linux-distro"><a class="header" href="#why-use-fedora-coreos-instead-of-a-traditional-linux-distro">Why use Fedora CoreOS instead of a traditional Linux distro?</a></h2>
<p>There are several benefits:</p>
<ul>
<li>Automatic update</li>
<li>Atomic upgrade</li>
<li>Immutable</li>
<li>Minimal</li>
<li>Faster install time (3 minutes compare to 5 minutes on Fedora or CentOS)</li>
<li>Faster provisioning (Docker already installed, save 5 minutes)</li>
</ul>
<p>However this is a fairly new distro, so it may not be really stable yet.</p>
<h2 id="where-terraform-state-is-stored"><a class="header" href="#where-terraform-state-is-stored">Where Terraform state is stored?</a></h2>
<p>In a Docker container on the first node, which was created by the <code>./metal</code> layer (it's not HA <em>yet</em>).</p>
<p>However I'm experimenting with Cluster API, remove the needs for a Terraform state storage.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="changelog"><a class="header" href="#changelog">Changelog</a></h1>
<h2 id="003-alpha"><a class="header" href="#003-alpha">0.0.3-alpha</a></h2>
<ul>
<li>Generate Terraform backend config automatically</li>
<li>Switch to CoreOS</li>
<li>Better PXE boot setup</li>
<li>Diagrams as code</li>
</ul>
<h2 id="002-alpha"><a class="header" href="#002-alpha">0.0.2-alpha</a></h2>
<ul>
<li>Ensure idempotency for bare metal provisioning</li>
<li>Extract instead of mounting the OS ISO file</li>
<li>Easy initial controller setup (with only Docker)</li>
<li>Switch to Fedora</li>
<li>Remove LXD</li>
<li>Move etcd (Terraform state backend) back to Docker</li>
</ul>
<h2 id="001-alpha"><a class="header" href="#001-alpha">0.0.1-alpha</a></h2>
<ul>
<li>Bare metal provisioning with PXE</li>
<li>LXD cluster</li>
<li>Terraform state backend (etcd)</li>
<li>RKE cluster</li>
<li>Core services (Vault, Gitea, ArgoCD,...)</li>
<li>Public services to the internet (via port forwarding or Cloudflare Tunnel)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="roadmap"><a class="header" href="#roadmap">Roadmap</a></h1>
<p>Current status: <strong>Alpha</strong></p>
<h2 id="beta-requirements"><a class="header" href="#beta-requirements">Beta requirements</a></h2>
<p>Good enough for playaround with and personal use</p>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
Automated bare metal provisioning
<ul>
<li><input disabled="" type="checkbox" checked=""/>
Controller set up (Docker)</li>
<li><input disabled="" type="checkbox" checked=""/>
OS installation (PXE boot)</li>
</ul>
</li>
<li><input disabled="" type="checkbox" checked=""/>
Automated cluster creation (Terraform)</li>
<li><input disabled="" type="checkbox" checked=""/>
Automated application deployment (ArgoCD)</li>
<li><input disabled="" type="checkbox" checked=""/>
Everything is defined as code</li>
<li><input disabled="" type="checkbox"/>
Basic services
<ul>
<li><input disabled="" type="checkbox" checked=""/>
Gitea</li>
<li><input disabled="" type="checkbox" checked=""/>
DoneCI</li>
<li><input disabled="" type="checkbox"/>
NextCloud</li>
<li><input disabled="" type="checkbox"/>
PeerTube,</li>
<li><input disabled="" type="checkbox"/>
Mail server</li>
<li><input disabled="" type="checkbox"/>
Mattermost</li>
<li><input disabled="" type="checkbox"/>
Matrix with bridges</li>
<li><input disabled="" type="checkbox"/>
Vault</li>
<li><input disabled="" type="checkbox"/>
VPN</li>
<li><input disabled="" type="checkbox"/>
Dashboard</li>
<li><input disabled="" type="checkbox" checked=""/>
Cloudflare tunnel (optional)</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
Local DNS</li>
<li><input disabled="" type="checkbox"/>
Mirror all git repositories from GitHub automatically</li>
<li><input disabled="" type="checkbox"/>
Monitoring and alerting</li>
<li><input disabled="" type="checkbox"/>
Local container registry</li>
<li><input disabled="" type="checkbox"/>
SSO</li>
<li><input disabled="" type="checkbox"/>
Backup solution (3 copies, 2 seperate devices, 1 offsite)</li>
<li><input disabled="" type="checkbox"/>
70% availability (might break in the weekend due to new experimentation)</li>
</ul>
<h2 id="stable-requirements"><a class="header" href="#stable-requirements">Stable requirements</a></h2>
<p>Can be used in &quot;production&quot; (for family or even small scale bussinesses)</p>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
A single command to deploy everything</li>
<li><input disabled="" type="checkbox" checked=""/>
Fast deployment time (from empty hard drive to running services under 1 hour)</li>
<li><input disabled="" type="checkbox"/>
Fully <em>automatic</em>, not just <em>automated</em>
<ul>
<li><input disabled="" type="checkbox"/>
Bare-metal OS patching</li>
<li><input disabled="" type="checkbox"/>
Backups</li>
<li><input disabled="" type="checkbox"/>
Secrets management and rotation</li>
<li><input disabled="" type="checkbox"/>
Self healing</li>
<li><input disabled="" type="checkbox"/>
Autoscale to save electricity (optional)</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
99,9% availability (less than 9 hours of downtime per year)</li>
<li><input disabled="" type="checkbox"/>
Backup encrytion</li>
<li><input disabled="" type="checkbox"/>
Split DNS</li>
<li><input disabled="" type="checkbox"/>
Secure by default</li>
<li><input disabled="" type="checkbox"/>
Static code analysis</li>
<li><input disabled="" type="checkbox"/>
Minimal dependency on external services</li>
<li><input disabled="" type="checkbox" checked=""/>
Only use open-source technologies</li>
<li><input disabled="" type="checkbox"/>
Complete documentation and architecture diagram (automated update if possible)
<ul>
<li><input disabled="" type="checkbox"/>
Book (this book)</li>
<li><input disabled="" type="checkbox"/>
Walkthrough building tutorial and feature demo (video)</li>
</ul>
</li>
</ul>
<h2 id="unplanned"><a class="header" href="#unplanned">Unplanned</a></h2>
<p>Nice to have</p>
<ul>
<li><input disabled="" type="checkbox"/>
Addition services (TBD)</li>
<li><input disabled="" type="checkbox"/>
Air-gap install</li>
<li><input disabled="" type="checkbox"/>
Automated testing</li>
<li><input disabled="" type="checkbox"/>
Security audit</li>
<li><input disabled="" type="checkbox"/>
Migrate to RKE2 (new Terraform provider for RKE2 is not release yet)</li>
<li><input disabled="" type="checkbox"/>
Serverless (OpenFaaS/Kubeless/Fission/Supabase...)</li>
<li><input disabled="" type="checkbox"/>
Cluster API (https://github.com/khuedoan/homelab/pull/2)</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
